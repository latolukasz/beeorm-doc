# Lazy Flush

In many scenarios, adding, editing, and deleting entities can be done asynchronously using BeeORM's `engine.FlushLazy` method. This method adds the necessary SQL queries to a special [redis stream](https://redis.io/docs/data-types/streams/) called `orm-lazy-channel`. A [background consumer](/guide/background_consumer.html) script can then read these queries from the stream and execute them.

Here's an example of how to use `FlushLazy`:

<code-group>
<code-block title="code">
```go{3,8,12}
// adding new entity
user := &UserEntity{FirstName: "Tom", LastName: "Bee", Email: "bee@beeorm.io"}
engine.FlushLazy(user) 

// updating entity
engine.LoadByID(1, user)
user.Name = "John"
engine.LoadByID(2, user2)
user.Name = "Ivona"
engine.FlushLazy(user, user2)

// deleting entity
engine.LoadByID(2, user)
engine.DeleteLazy(user)
```
</code-block>

<code-block title="queries">
```sql
REDIS XAdd orm-lazy-channel event
REDIS XAdd orm-lazy-channel event
REDIS XAdd orm-lazy-channel event
```
</code-block>
</code-group>

Don't forget to run the [background consumer](/guide/background_consumer.html) in your application which is reading
all queries from redis stream and executes them. You can easily check statistics of this stream:

```go
statistics := engine.GetEventBroker().GetStreamGroupStatistics(beeorm.LazyChannelName, beeorm.BackgroundConsumerGroupName)
statistics.Lag // shows how many lazy queries are still in stream waiting to be executed, works only with redis 7
statistics.Pending // shows how many lazy queries are now processed by `BackgroundConsumer`
statistics.LowerDuration // how old is the oldest query wating in stream to be executed
```

We will explain more above statistics on [stream statistics page](/guide/event_broker.html#stream-statistics)

## Defining lazy queries pool name

By default BeeORM creates stream in `default` [redis data pool](/guide/data_pools.html#redis-server-pool).
You can provide different pool name by registering stream `beeorm.LazyChannelName` together with `beeorm.BackgroundConsumerGroupName`
consumer group name and your redis pool name, as showed on below example

<code-group>
<code-block title="code">
```go{3}
registry := beeorm.NewRegistry()
registry.RegisterRedis("192.123.11.12:6379", "", 0, "lazy")
registry.RegisterRedisStream(beeorm.LazyChannelName, "lazy", []string{beeorm.BackgroundConsumerGroupName})
```
</code-block>

<code-block title="yaml">
```yml{4,5}
lazy:
    redis: 192.123.11.12:6379
    streams:
        orm-lazy-channel:
          - orm-async-consumer
```
</code-block>
</code-group>

## Defining lazy queries workers
You can define how many SQL queries generated by `engine.FlushLazy()` should be executed at the same time in
parallel. By default Background consumer runs 11 queries in parallel. You can change it using
`SetLazyFlushWorkers` method:

```go{2}
consumer := beeorm.NewBackgroundConsumer(engine)
consumer.SetLazyFlushWorkers(20)
```

## Error resolver

TODO

## Not allowed actions (ON DUPLIKATE KEY, references)

TODO
